# MCP サーバー活用ガイド

## 概要
このプロジェクトでは、以下のMCP（Model Context Protocol）サーバーを活用して、開発効率と品質を向上させます。

---

## 利用可能なMCPサーバー

### 1. Cipher（対話記録）
**目的**: 開発セッションの記録と復旧

**主な機能**:
- 対話履歴の永続化
- クラッシュ時の復旧支援
- 意思決定の記録

**設定場所**: `~/.claude/config.json`
```json
{
  "mcpServers": {
    "cipher": {
      "command": "/opt/homebrew/bin/cipher",
      "args": ["--mode", "mcp"]
    }
  }
}
```

### 2. Serena（インテリジェントコーディング）
**目的**: プロジェクト固有のコンテキストを活用したコーディング支援

**主な機能**:
- プロジェクト構造の理解
- コード生成の最適化
- ベストプラクティスの提案

**このプロジェクトの設定**:
```json
{
  "mcpServers": {
    "serena-chatbot": {
      "command": "uvx",
      "args": [
        "--from",
        "git+https://github.com/oraios/serena",
        "serena",
        "start-mcp-server",
        "--context",
        "ide-assistant",
        "--project",
        "/Users/aa479881/Library/CloudStorage/GoogleDrive-horie.kenichi@grtx.jp/共有ドライブ/103_全社共有用/社内DX/chatbot"
      ]
    }
  }
}
```

---

## Cipher の活用方法

### 基本的な使い方

#### 1. セッション開始時
**記録すべき内容**:
```
プロジェクト: マーケティングナレッジチャットボット
セッション日時: YYYY-MM-DD HH:MM
目的: [今回実施する作業]
前回の続き: [前回のセッションからの続き]
```

#### 2. 重要な意思決定時
**記録すべき内容**:
```
決定事項: [何を決定したか]
理由: [なぜその決定をしたか]
影響範囲: [どのファイル・機能に影響するか]
代替案: [検討した他の選択肢]
```

#### 3. コード変更時
**記録すべき内容**:
```
変更ファイル: src/path/to/file.ts
変更内容: [簡潔な説明]
変更理由: [なぜこの変更が必要か]
影響範囲: [他のファイルへの影響]
テスト結果: [動作確認結果]
```

#### 4. 問題発生時
**記録すべき内容**:
```
問題: [何が起きたか]
エラーメッセージ: [詳細なエラー]
試した解決策: [どのような対処を試したか]
解決方法: [最終的な解決策]
```

#### 5. セッション終了時
**記録すべき内容**:
```
実施内容サマリー: [今回実施した作業の要約]
完了タスク: [完了したタスク]
次のステップ: [次回やるべきこと]
注意事項: [引き継ぎ事項]
```

### クラッシュからの復旧手順

1. **Claude Codeを再起動**
2. **Cipherの記録を確認** (自動的に利用可能)
3. **最後のセッション記録を参照**
4. **「次のステップ」から作業を再開**
5. **変更途中のファイルを確認**

---

## Serena の活用方法

### 基本的な使い方

#### 1. コード生成前の設計確認
**質問例**:
```
「この機能を実装する前に、プロジェクト構造を考慮して
最適な実装方法を提案してください」
```

#### 2. コードレビュー
**質問例**:
```
「このコードはプロジェクトのアーキテクチャと整合性が
取れていますか？改善点を教えてください」
```

#### 3. ベストプラクティスの確認
**質問例**:
```
「このプロジェクトでのエラーハンドリングの標準的な
方法を教えてください」
```

#### 4. リファクタリング提案
**質問例**:
```
「この関数をプロジェクトの他の部分と一貫性のある
形にリファクタリングしてください」
```

---

## 実践例

### 例1: 新機能実装時のフロー

#### ステップ1: Cipherに記録
```
【Cipher記録】
機能: チャットメッセージ送信機能
目的: ユーザーがメッセージを送信できるようにする
実装ファイル: src/app/api/chat/route.ts
```

#### ステップ2: Serenaで設計確認
```
【Serenaに質問】
「チャットAPIを実装したいです。プロジェクトのAPIルート
の標準的な構造を教えてください」

【Serena回答】
- エラーハンドリングの標準
- リクエストバリデーション方法
- レスポンス形式
```

#### ステップ3: 実装
```typescript
// 実装コード
```

#### ステップ4: Cipherに結果を記録
```
【Cipher記録】
実装完了: チャットメッセージ送信機能
テスト結果: ✅ 正常動作確認
次のステップ: メッセージ受信機能の実装
```

---

### 例2: バグ修正時のフロー

#### ステップ1: Cipherに問題を記録
```
【Cipher記録】
問題: ベクトル検索時にエラー発生
エラー: "Cannot read property 'embedding' of undefined"
発生条件: 空の検索クエリ時
```

#### ステップ2: Serenaで類似コードを確認
```
【Serenaに質問】
「このプロジェクトで、他のAPIエンドポイントでは
入力バリデーションをどのように実装していますか？」
```

#### ステップ3: 修正
```typescript
// 修正コード
if (!query || query.trim() === '') {
  return Response.json(
    { error: 'Query is required' },
    { status: 400 }
  );
}
```

#### ステップ4: Cipherに解決策を記録
```
【Cipher記録】
解決策: 入力バリデーションを追加
修正ファイル: src/app/api/search/route.ts
テスト結果: ✅ エラーハンドリング正常動作
```

---

## 定期的な記録タイミング

### 毎回必須
- [ ] セッション開始時
- [ ] セッション終了時
- [ ] 重要な意思決定時

### 推奨
- [ ] 新機能実装開始時
- [ ] 新機能実装完了時
- [ ] バグ発見時
- [ ] バグ修正完了時
- [ ] アーキテクチャ変更時

### 任意（有用な場合）
- [ ] コードレビュー時
- [ ] パフォーマンス改善時
- [ ] リファクタリング時

---

## チェックリスト

### セッション開始時
- [ ] 前回のCipher記録を確認
- [ ] 今回の作業目的をCipherに記録
- [ ] Serenaでプロジェクト状況を確認

### 実装中
- [ ] 重要な決定をCipherに記録
- [ ] Serenaでベストプラクティスを確認
- [ ] 変更内容をCipherに記録

### セッション終了時
- [ ] 実施内容をCipherに記録
- [ ] 次のステップをCipherに記録
- [ ] docs/session-log.mdを更新

---

## トラブルシューティング

### Cipherが動作しない
```bash
# Cipherのインストール確認
which cipher

# 設定ファイルの確認
cat ~/.claude/config.json
```

### Serenaが動作しない
```bash
# uvxのインストール確認
which uvx

# Serenaの手動起動テスト
uvx --from git+https://github.com/oraios/serena serena --help
```

### Claude Codeの再起動
1. VS Codeを完全に終了
2. 再起動
3. Claude Codeセッションを開始

---

## ベストプラクティス

### 記録の粒度
- **粗すぎる**: 「コードを書いた」 → ❌
- **適切**: 「src/app/api/chat/route.tsにPOSTエンドポイントを実装。Gemini APIと統合。」 → ✅
- **細かすぎる**: 「変数nameをmessageに変更」 → ❌（重要でない変更）

### 記録のタイミング
- **悪い**: 1日の終わりにまとめて記録 → 忘れる
- **良い**: 重要なアクション直後に記録 → 正確

### Serenaの活用
- **悪い**: コード生成後に「これで合ってますか？」
- **良い**: コード生成前に「最適な方法は？」

---

このガイドに従うことで、クラッシュ時の復旧が容易になり、開発効率が向上します。
