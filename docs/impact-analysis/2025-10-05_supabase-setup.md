# 影響範囲分析：Supabaseセットアップ

## 基本情報

- **日時**: 2025-10-05
- **担当者**: Claude Code
- **変更理由**: ベクトルDBの構築（RAG機能の基盤）

---

## 変更内容

### 変更対象ファイル
- [ ] `supabase/migrations/001_initial_schema.sql` - 新規作成
- [ ] `src/lib/supabase.ts` - 新規作成
- [ ] `package.json` - Supabaseクライアント追加
- [ ] `.env.example` - 環境変数例を更新
- [ ] `docs/supabase-setup.md` - セットアップガイド新規作成

### 変更概要
```
Supabaseプロジェクトのセットアップと、
ベクトルDB用のデータベーススキーマを作成する。
```

### 実施内容
1. Supabaseプロジェクト作成手順のドキュメント化
2. データベーススキーマ（マイグレーション）作成
   - `knowledge_base` テーブル（ベクトルストア）
   - `chat_history` テーブル（チャット履歴）
3. Supabaseクライアントライブラリのセットアップ
4. 環境変数の設定

---

## 影響範囲分析

### 1. 直接的な影響

#### 新規作成ファイル
- `supabase/migrations/001_initial_schema.sql` - DBスキーマ
- `src/lib/supabase.ts` - クライアント設定
- `docs/supabase-setup.md` - セットアップガイド

#### 変更ファイル
- `package.json` - 依存関係追加
  ```json
  "@supabase/supabase-js": "^2.x.x"
  ```
- `.env.example` - 環境変数例追加
  ```
  NEXT_PUBLIC_SUPABASE_URL=
  NEXT_PUBLIC_SUPABASE_ANON_KEY=
  SUPABASE_SERVICE_ROLE_KEY=
  ```

### 2. 間接的な影響

#### 今後実装する機能への影響
```
Supabaseセットアップ
  ↓
データ同期スクリプト（次のステップ）
  ↓
RAG検索機能（その次）
  ↓
チャット履歴機能（その次）
```

#### データフロー
```
Google Sheets
  ↓（データ同期スクリプト）
Supabase knowledge_base テーブル
  ↓（ベクトル検索）
Gemini API（回答生成）
  ↓
Supabase chat_history テーブル（履歴保存）
```

### 3. 型定義の変更

新規型定義が必要:
- `src/types/knowledge.ts` - ナレッジデータ型
- `src/types/chat.ts` - チャット履歴型

### 4. API契約の変更

現時点では影響なし（新規セットアップのため）

---

## リスク評価

### 高リスク（破壊的変更）
- [ ] なし（新規セットアップのため）

### 中リスク
- [ ] Supabase無料枠の制限
  - 対策: 使用量監視、必要に応じて有料プラン検討

### 低リスク
- [ ] 環境変数の設定ミス
  - 対策: `.env.example` に明確な説明を記載
- [ ] マイグレーション実行ミス
  - 対策: ローカルで十分にテスト

---

## テスト計画

### ユニットテスト
この段階では不要（セットアップのみ）

### 統合テスト
- [ ] Supabaseクライアントの接続確認
- [ ] テーブル作成確認
- [ ] pgvector拡張機能の有効化確認

### 手動テスト項目
1. [ ] Supabaseプロジェクトが作成できる
2. [ ] マイグレーションが正常に実行できる
3. [ ] Supabaseクライアントから接続できる
4. [ ] テーブルが正しく作成されている
5. [ ] ベクトル検索用のインデックスが作成されている

---

## ロールバック計画

### ロールバック手順
1. Supabaseプロジェクトを削除
2. 環境変数を削除
3. 追加したコードを削除

### ロールバック時の注意点
- データは存在しないため、ロールバックによるデータ損失なし

---

## ユーザー確認事項

### 確認が必要なポイント
1. Supabaseプロジェクトを作成してよいか？
2. 環境変数の設定方法は理解されているか？
3. Supabaseの無料枠で開始してよいか？

### 実施内容
- [ ] Supabaseアカウント作成
- [ ] プロジェクト作成
- [ ] 環境変数設定
- [ ] マイグレーション実行

### ユーザー承認
- [x] 影響範囲を確認し、実装を承認（2025-10-05）

---

## 実装ステップ

### ステップ1: ドキュメント作成
- [ ] `docs/supabase-setup.md` - セットアップ手順

### ステップ2: マイグレーション作成
- [ ] `supabase/migrations/001_initial_schema.sql`

### ステップ3: クライアント設定
- [ ] Supabaseクライアントライブラリのインストール
- [ ] `src/lib/supabase.ts` 作成
- [ ] 型定義ファイル作成

### ステップ4: 環境変数設定
- [ ] `.env.example` 更新
- [ ] ユーザーに `.env.local` 設定を依頼

### ステップ5: 動作確認
- [ ] 接続テスト
- [ ] テーブル確認

---

## 実装後の結果

### テスト結果
（実装後に記入）

### 発見された問題
（実装後に記入）

### 追加の変更
（実装後に記入）

---

## 備考

- Supabaseの東京リージョン（ap-northeast-1）を推奨
- 無料枠: 500MB DB、2GB転送/月
- pgvector拡張機能が必要
